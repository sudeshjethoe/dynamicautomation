---
layout: post
status: publish
published: true
title: Booting SystemRescueCD ISO from EFI on Fedora 28 Linux
author:
  display_name: Sudesh Jethoe
  login: sudeshjethoe
  email: sudesh@jethoe.nl
  url: ''
author_login: sudeshjethoe
author_email: sudesh@jethoe.nl
wordpress_id: 1834
wordpress_url: https://www.dynamicautomation.nl/?p=1834
date: '2018-07-26 01:08:31 +0200'
date_gmt: '2018-07-25 23:08:31 +0200'
categories:
- linux
- lvm
- efi
- grub2
- fedora
tags: []
comments: []
---
<h1>Introduction</h1>
<p>Yesterday I noticed that my Thinkpad X1 laptop had assigned too little diskspace to its OS partition. As it was running in a physical partition and not a logical one, it was time to move it to LVM. Unfortunately I had no USB sticks anymore.<br />
As such I decided to move the whole system partition to LVM by using the SystemRescueCD (sysrcd) livecd booting directly from the disk itself.</p>
<p>It was quite a puzzle to get this done, therefore I decided to write it down for whoever might need to do the same thing.</p>
<h1>Steps</h1>
<ol>
<li>Confirm startup mode and disk layout</li>
<li>Download sysrcd and copy to the right location</li>
<li>Configure grub2 to read the sysrcd iso</li>
<li>Update grub2</li>
<li>Update EFI/BIOS boot settings</li>
<li>Boot into sysrcd</li>
</ol>
<h3 style="padding-left: 30px;">Checking startup mode and disk layout</h3>
<p>As its possible to run modern systems in EFI and BIOS mode and this tutorial is mode specifically for systems in EFI mode with GPT disk layout check these before you continue.</p>
<h5 style="padding-left: 60px;">Check EFI or BIOS</h5>
<p>To check if you are running in EFI, you can use the following commands</p>
<pre># if this folder exists you're running in EFI mode
$ ls /sys/firmware/efi/
config_table efivars esrt fw_platform_size fw_vendor runtime runtime-map systab

# this command will show output when running in EFI mode (not installed by default)
$ efibootmgr 
BootCurrent: 0012
Timeout: 0 seconds
BootOrder: 0012,0013,0000,0001,0002,0003,000C,0007,0008,0009,000A,000B,000D
Boot0000 Setup
Boot0001 Boot Menu
Boot0002 Diagnostic Splash Screen
Boot0003 Lenovo Diagnostics
---
Boot0012* Fedora
Boot0013* Windows Boot Manager</pre>
<h5 style="padding-left: 60px;">Check disk layout</h5>
<p>EFI systems support the classical disk layout (MBR or master boot record layout), but also a modern one which is called the GPT or GUID Partition Table layout. There are quite some differences between both, one of them being that MBR only supports 4 primary partitions with sizes up to 2 TB, GPT can go up to at least 128 and up to 1 ZB partition size (256 TB on Windows). As GRUB2 addresses these layouts differently it's important to ensure you're using GPT before we continue (if you're not using GPT, just use the normal instructions described on the <a href="https://help.ubuntu.com/community/Grub2/ISOBoot/Examples#SystemRescueCD" target="_blank" rel="noopener">Ubuntu GRUB2 Example pages</a>.</p>
<pre>$ gdisk -l /dev/sda
GPT fdisk (gdisk) version 1.0.3

Partition table scan:
MBR: protective
BSD: not present
APM: not present
GPT: present

Found valid GPT with protective MBR; using GPT.
</pre>
<p>Output of <b>gdisk</b> when ran against a GPT formatted disk.</p>
<h3 style="padding-left: 30px;">Download SystemRescueCD</h3>
<p>Ofcourse the first step is to download the SystemRescueCD from the website here:&nbsp;<a href="http://www.system-rescue-cd.org/Download/" target="_blank" rel="noopener">Download</a>. For GRUB2 to be able to read the ISO file, it needs to be placed <strong>on the same partition as the /boot partition</strong>. In my case this is the system partition itself. For convenience I follow the instructions described on the <a href="http://www.system-rescue-cd.org/manual/Installing_SystemRescueCd_on_the_disk/" target="_blank" rel="noopener">SystemRescueCD documentation page</a> and place the ISO in:</p>
<pre>/boot/sysrcd/systemrescuecd-x86-x.y.z.iso</pre>
<p>Now let's continue to the next step and configure GRUB2</p>
<h3 style="padding-left: 30px;">Configuring GRUB2</h3>
<p>Before making changes to GRUB2, we need to dive a bit into how GRUB2 is actually setup in Fedora systems.<br />
The GRUB2 system can be quite daunting and complex, but for this tutorial you only need to know the following commands and locations:</p>
<pre># write a new Grub2 EFI configuration for fedora on EFI
grub2-mkconfig -o /boot/efi/EFI/fedora/grub.cfg

# location of default grub configuration settings
/etc/default/grub

# location of grub2 configurable OSes
/etc/grub.d/

# final location of compiled grub2 configuration (!do not edit this file directly!)
/boot/efi/EFI/fedora/grub.cfg
</pre>
<p>Now let's create our new GRUB2 configuration, by creating a new grub configuration in <strong>/etc/grub.d/20_sysrcd</strong><br />
<code lang="bash" line_numbers="true">#!/bin/sh<br />
exec tail -n +3 $0<br />
# This file provides an easy way to add custom menu entries.  Simply type the<br />
# menu entries you want to add after this comment.  Be careful not to change<br />
# the 'exec tail' line above.<br />
menuentry 'SystemRescueCD (64-bit) ' {<br />
set root='hd0,gpt6'<br />
set isofile="/boot/sysrcd/systemrescuecd-x86-5.2.2.iso"<br />
loopback loop (hd0,gpt6)$isofile<br />
linuxefi (loop)/isolinux/rescue64 setkmap=us isoloop=$isofile docache<br />
initrdefi (loop)/isolinux/initram.igz<br />
}</code><br />
After writing the file, don't forget to make it executable with <strong>chmod +x /etc/grub.d/20_sysrcd</strong>.</p>
<h3 style="padding-left: 30px;">Installing the updated GRUB2 configuration</h3>
<p>Now run the update grub command for Fedora on EFI<br />
<code>grub2-mkconfig -o /boot/efi/EFI/fedora/grub.cfg</code></p>
<p>This command writes a new configuration to /boot/efi/EFI/fedora/grub.cfg, a new section in this file should pop-up now:<br />
<code lang="bash>### BEGIN /etc/grub.d/20_sysrescd ###<br />
# This file provides an easy way to add custom menu entries.  Simply type the<br />
# menu entries you want to add after this comment.  Be careful not to change<br />
# the 'exec tail' line above.<br />
menuentry 'SystemRescueCD (64-bit) ' {<br />
        set root='hd0,gpt6'<br />
        set isofile="/boot/sysrcd/systemrescuecd-x86-5.2.2.iso"<br />
        loopback loop (hd0,gpt6)$isofile<br />
        linuxefi (loop)/isolinux/rescue64 setkmap=us isoloop=$isofile docache<br />
        initrdefi (loop)/isolinux/initram.igz<br />
}<br />
### END /etc/grub.d/20_sysrescd ###</code></p>
<p>After restarting the system you should now be able to select "System Rescue CD" as a boot option, this will only work when you have disabled "secure boot" in your BIOS!</p>
<p>&nbsp;</p>
<h1>Sources</h1>
<ul>
<li><a href="https://docs.fedoraproject.org/f27/system-administrators-guide/kernel-module-driver-configuration/Working_with_the_GRUB_2_Boot_Loader.html" target="_blank" rel="noopener">Fedora 27 "Working with the Grub2 bootloader"</a></li>
<li><a href="http://www.system-rescue-cd.org/manual/Installing_SystemRescueCd_on_the_disk/" target="_blank" rel="noopener">Installing SystemRescueCd on the disk</a></li>
<li><a href="https://help.ubuntu.com/community/Grub2/ISOBoot" target="_blank" rel="noopener">Ubuntu docs, Grub2 ISOBoot</a></li>
<li><a href="https://help.ubuntu.com/community/Grub2/ISOBoot/Examples#SystemRescueCD" target="_blank" rel="noopener">Grub2 ISOBoot example SystemRescueCD</a></li>
</ul>
<p>&nbsp;</p>
